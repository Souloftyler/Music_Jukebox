<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grimoire Royal - La Qu√™te de l'√âquilibre</title>
    <!-- Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'parchment-base': '#fcf4d4', 
                        'parchment-shadow': '#e0cdb2', 
                        'ink-dark': '#301f14', 
                        'ornate-gold': '#cdac60', 
                        'royal-blue': '#3e5c76', 
                    },
                    fontFamily: {
                        title: ['Uncial Antiqua', 'Cinzel', 'serif'],
                        body: ['IM Fell English', 'serif'],
                    },
                    boxShadow: {
                        'grimoire-3d': '10px 10px 40px rgba(0,0,0,0.7)',
                    }
                }
            }
        }

        // --- Donn√©es du Jeu (Narrative Game Data - Nouvelle Histoire) ---
        const gameData = {
            // CHAPITRE I : Le Serment du Moine (3 CHOIX)
            "start": {
                title: "Le Serment des Voeux Bris√©s",
                text: "Depuis la d√©couverte d'un manuscrit cod√© dans les archives du Monast√®re des Sables Gris, vous, Fr√®re Kael, savez la v√©rit√© : l'√©quilibre du monde repose sur la restitution des Cendres des Anciens H√©ros au Sanctuaire du Feu Sacr√©. L'Ombre Dormante se r√©veille. Vous quittez l'habit monacal et, sans armure ni or, vous partez avec juste votre foi et le Compendium. L'unique piste m√®ne √† la capitale marchande d'Aethelgard. Comment voyagez-vous ?",
                choices: [
                    { text: "Prendre les chemins principaux, rapides mais risqu√©s.", target: "chapitre_1_chemins_risques" },
                    { text: "Couper √† travers la For√™t Oubli√©e, lente mais discr√®te.", target: "chapitre_1_foret_oubliee" },
                    { text: "Suivre un ancien sentier de p√®lerinage, plus s√ªr mais tr√®s long.", target: "chapitre_1_pelerinage" }
                ]
            },
            
            // BRANCHES DE VOYAGE VERS AETHELGARD (3 CHOIX DE CONTINUATION)
            "chapitre_1_chemins_risques": {
                title: "Vers Aethelgard: Le Prix de la Vitesse",
                text: "Sur les routes poussi√©reuses, vous √™tes rep√©r√© par des brigands. Votre v√™tement de moine-chevalier sans armure les amuse. Ils vous d√©pouillent de votre bourse vide et vous laissent partir, croyant n'avoir affaire qu'√† un fou. Vous arrivez √† Aethelgard affam√© et honteux.",
                choices: [
                    { text: "Chercher imm√©diatement l'Antiquaire pour la premi√®re piste.", target: "chapitre_1_ville_antiquaire" },
                    { text: "Trouver une √©glise ou un temple pour prier et demander l'aum√¥ne.", target: "chapitre_1_eglise" },
                    { text: "Tenter de se faire engager comme porteur pour gagner quelques pi√®ces (perdre une journ√©e).", target: "chapitre_1_travail_perdu" }
                ]
            },
            "chapitre_1_foret_oubliee": {
                title: "L'Ombre de la For√™t: L'Avertissement",
                text: "La for√™t est une tapisserie d'ombres. Vous rencontrez l'Ermite de la Faille qui vous offre de l'eau et vous met en garde contre l'Ombre. Elle vous donne un petit talisman de bois tordu, 'pour les jours de grande incertitude'. Vous arrivez √† Aethelgard avec un jour de retard, mais intact.",
                choices: [
                    { text: "Chercher imm√©diatement l'Antiquaire pour la premi√®re piste.", target: "chapitre_1_ville_antiquaire" },
                    { text: "M√©diter sur les paroles de l'Ermite dans le Jardin d'un temple.", target: "chapitre_1_meditation" },
                    { text: "Vendre le talisman sur le march√© pour acheter de la nourriture (vous avez faim).", target: "chapitre_1_vendre_talisman" }
                ]
            },
            "chapitre_1_pelerinage": {
                title: "Le Long Chemin de la Foi",
                text: "Le sentier des p√®lerins est difficile, mais paisible. Apr√®s plusieurs jours, vous arrivez √† Aethelgard, fatigu√©, mais fortifi√© par la discipline. Votre habit simple vous fait passer inaper√ßu dans la foule anim√©e de la ville.",
                choices: [
                    { text: "Chercher imm√©diatement l'Antiquaire pour la premi√®re piste.", target: "chapitre_1_ville_antiquaire" },
                    { text: "Visiter la biblioth√®que pour tenter de d√©chiffrer une partie du manuscrit.", target: "chapitre_1_bibliotheque" },
                    { text: "Observer la ville et les gens avant d'agir.", target: "chapitre_1_observation" }
                ]
            },

            // CONS√âQUENCES DU VOYAGE (BRANCHES INTERM√âDIAIRES)
            "chapitre_1_eglise": {
                title: "Le Secours de l'√âglise",
                text: "Un pr√™tre compatissant vous donne un repas et vous offre une petite bourse. Vous √™tes repos√© et pr√™t √† continuer.",
                choices: [
                    { text: "Aller trouver l'Antiquaire.", target: "chapitre_1_ville_antiquaire" }
                ]
            },
            "chapitre_1_travail_perdu": {
                title: "Le Temps Perdu",
                text: "Apr√®s une journ√©e de labeur, vous n'avez qu'une poign√©e de pi√®ces et vous √™tes √©puis√©. L'Ombre Dormante gagne du temps.",
                choices: [
                    { text: "Aller trouver l'Antiquaire.", target: "chapitre_1_ville_antiquaire" }
                ]
            },
            "chapitre_1_meditation": {
                title: "Clart√© et Sagesse",
                text: "La m√©ditation vous offre un aper√ßu de la nature trompeuse du mal. Vous gagnez en clart√© spirituelle pour le reste de la qu√™te.",
                choices: [
                    { text: "Aller trouver l'Antiquaire.", target: "chapitre_1_ville_antiquaire" }
                ]
            },
            "chapitre_1_vendre_talisman": {
                title: "Le Prix de la Faim",
                text: "Vous vendez le talisman. Vous √™tes rassasi√©, mais un sentiment de regret vous ronge d'avoir c√©d√© un cadeau mystique pour si peu.",
                choices: [
                    { text: "Aller trouver l'Antiquaire.", target: "chapitre_1_ville_antiquaire" }
                ]
            },
            "chapitre_1_bibliotheque": {
                title: "Recherche et D√©couverte",
                text: "Vous passez des heures √† la biblioth√®que, d√©chiffrant une seule phrase cruciale du manuscrit : 'La Sagesse est gard√©e par la Prudence.' Un indice pr√©cieux pour la suite.",
                choices: [
                    { text: "Aller trouver l'Antiquaire.", target: "chapitre_1_ville_antiquaire" }
                ]
            },
            "chapitre_1_observation": {
                title: "La Vigilance du Moine",
                text: "En observant les ruelles, vous remarquez une ombre vous suivant. Vous la semez facilement, conscient d'avoir √©t√© rep√©r√© par des agents du mal.",
                choices: [
                    { text: "Aller trouver l'Antiquaire.", target: "chapitre_1_ville_antiquaire" }
                ]
            },


            // CHAPITRE II : Les Cendres de la Sagesse (3 CHOIX)
            "chapitre_1_ville_antiquaire": {
                title: "L'Antiquaire de la Capitale",
                text: "Maitre Elmsworth, l'antiquaire, est r√©ticent. Vous lui montrez le manuscrit cod√©. Il vous r√©v√®le que la premi√®re relique, les 'Cendres de la Sagesse', est cach√©e dans la Crypte du Guetteur Silencieux, accessible uniquement par une √©nigme. Elmsworth exige une preuve de votre engagement.",
                choices: [
                    { text: "Raconter votre serment et votre fuite du monast√®re.", target: "chapitre_2_enigme_1" },
                    { text: "Tenter de lui acheter l'information avec l'argent gagn√©/re√ßu (ou bluffer).", target: "chapitre_2_ville_echec" },
                    { text: "Proposer de faire une t√¢che simple et honn√™te pour lui en √©change.", target: "chapitre_2_ville_service" }
                ]
            },
            "chapitre_2_ville_echec": {
                title: "L'√âchec de la Conviction",
                text: "L'Antiquaire, irrit√© par votre bluff ou votre manque de moyens, vous chasse. Il est trop tard pour revenir en arri√®re ; le manuscrit vous obs√®de. L'Ombre Dormante gagne du temps.",
                choices: [
                    { text: "FIN : √âchec par Impuissance.", target: "end_fail" }
                ]
            },
            "chapitre_2_ville_service": {
                title: "Le Prix de l'Honn√™tet√©",
                text: "Vous passez la soir√©e √† r√©pertorier des parchemins pour l'Antiquaire. Satisfait par votre labeur, il vous donne l'√©nigme et vous laisse partir.",
                choices: [
                    { text: "Obtenir l'√ânigme : 'Je suis la pens√©e avant l'action...'", target: "chapitre_2_enigme_1" }
                ]
            },

            // √ânigme (3 CHOIX)
            "chapitre_2_enigme_1": {
                title: "Le Passage D√©rob√©",
                text: "L'√©nigme est : 'Je suis la pens√©e avant l'action, l'√©cho avant le cri. Si tu me perds, tu n'es plus qu'un pion. Qui suis-je ?' La Crypte se trouve dans les falaises au-dessus de la mer. Vous √™tes face au m√©canisme d'entr√©e.",
                choices: [
                    { text: "R√©ponse : La Prudence", target: "chapitre_2_crypte_prudence" },
                    { text: "R√©ponse : L'Ombre", target: "chapitre_2_crypte_echec_reponse" },
                    { text: "R√©ponse : Le Courage", target: "chapitre_2_crypte_echec_reponse" }
                ]
            },
            "chapitre_2_crypte_echec_reponse": {
                title: "L'Erreur et le Pi√®ge",
                text: "Vous prononcez le mot √† voix haute. Des sifflements remplissent la crypte. Le sol s'effondre sous vos pieds dans un nuage de poussi√®re et de d√©bris. Vous tombez, assomm√© par la pierre.",
                choices: [
                    { text: "FIN : √âchec par H√¢te.", target: "end_fail" }
                ]
            },
            "chapitre_2_crypte_prudence": {
                title: "Cendres de la Sagesse",
                text: "Vous murmurez : 'La Prudence'. Un m√©canisme s'enclenche, r√©v√©lant une chambre fun√©raire. Vous rassemblez les cendres, sentant une ancienne paix vous envahir. Les Cendres de la Sagesse sont √† vous. La prochaine destination est le village oubli√© de Kael-Dra, sur les Monts de Brume.",
                choices: [
                    { text: "Voyager vers Kael-Dra, √† la recherche des Cendres du Courage.", target: "chapitre_3_kael_dra_arrivee" }
                ]
            },

            // CHAPITRE III : Les Cendres du Courage (3 CHOIX)
            "chapitre_3_kael_dra_arrivee": {
                title: "Le Village de l'Oubli",
                text: "Kael-Dra est envelopp√© d'un silence pesant. Seule l'A√Æn√©e Mara est encore l√†. Elle garde les 'Cendres du Courage'. Elle vous raconte que depuis des mois, la terreur s'est install√©e : une 'B√™te de Brume' a chass√© les villageois. Elle n'abandonnera les cendres qu'en √©change d'une action pour sauver ce qui reste du village.",
                choices: [
                    { text: "Promettre d'affronter la B√™te de Brume (bien que sans arme).", target: "chapitre_3_promesse_action" },
                    { text: "Tenter de n√©gocier avec Mara, en expliquant l'urgence de l'√âquilibre.", target: "chapitre_3_negociation" },
                    { text: "Proposer de partir chercher de l'aide et des vivres en ville (perdre du temps, mais √™tre plus pr√©par√©).", target: "chapitre_3_chercher_aide" }
                ]
            },
            "chapitre_3_chercher_aide": {
                title: "La Voie de la L√¢chet√©",
                text: "L'A√Æn√©e Mara refuse. 'Le Courage est ici, ou il n'est nulle part. Le Mal ne prend pas de pause.' Elle se retire dans sa masure. Le Compendium vous avertit que vous avez trop tard√©.",
                choices: [
                    { text: "FIN : √âchec par Pr√©caution.", target: "end_fail" }
                ]
            },
            "chapitre_3_negociation": {
                title: "L'√âpreuve de la Confiance",
                text: "L'A√Æn√©e Mara vous regarde avec tristesse. 'La n√©gociation n'a pas sa place face au Mal. Si vous n'avez pas le c≈ìur de d√©fendre les faibles, comment pourrez-vous d√©fendre le monde ?'",
                choices: [
                    { text: "FIN : √âchec par √âgo√Øsme.", target: "end_fail" }
                ]
            },
            
            // CONFRONTATION AVEC LA B√äTE (3 CHOIX)
            "chapitre_3_promesse_action": {
                title: "Le Pi√®ge de l'Ombre",
                text: "Vous vous postez √† l'or√©e de la brume. La B√™te arrive : un loup massif et malade. L'A√Æn√©e Mara vous observe de loin. Le talisman de l'Ermite (si vous l'avez gard√©) vibre et vous montre une source de corruption dans l'eau du village, qui rend le loup fou.",
                choices: [
                    { text: "Tuer le loup pour satisfaire Mara et obtenir les Cendres.", target: "chapitre_3_tuer_loup_moral" },
                    { text: "Ignorer le loup et chercher la source de corruption dans la rivi√®re.", target: "chapitre_3_source_corruption" },
                    { text: "Utiliser un chant monastique de gu√©rison pour tenter de calmer la b√™te.", target: "chapitre_3_chant_calmant" }
                ]
            },
            "chapitre_3_tuer_loup_moral": {
                title: "Le Co√ªt de la C√©l√©rit√©",
                text: "Vous mettez fin √† la souffrance du loup, mais le Compendium semble se fermer. Vous avez sacrifi√© l'innocence pour le temps. Mara vous donne les Cendres du Courage, mais ses yeux sont emplis de d√©ception.",
                choices: [
                    { text: "Prendre les cendres et partir vers le Sanctuaire du Feu Sacr√©.", target: "chapitre_4_sanctuaire_approche" }
                ]
            },
            "chapitre_3_chant_calmant": {
                title: "La Force de l'√Çme",
                text: "Votre chant apaise temporairement la B√™te. Elle s'√©loigne, mais la corruption persiste. Vous gagnez la confiance de Mara, mais vous devez toujours r√©soudre le probl√®me de l'eau.",
                choices: [
                    { text: "Chercher la source de corruption dans la rivi√®re.", target: "chapitre_3_source_corruption" }
                ]
            },
            "chapitre_3_source_corruption": {
                title: "La Vraie Cause",
                text: "Vous trouvez la fissure suintante d'encre noire. Utilisant l'essence des Cendres de la Sagesse (Ash 1), vous la scellez. La B√™te, lib√©r√©e de la corruption, s'enfuit. Mara, impressionn√©e par votre compassion et votre sagesse, vous donne les Cendres du Courage. Vous avez prouv√© votre valeur.",
                choices: [
                    { text: "Prendre les cendres et partir vers le Sanctuaire du Feu Sacr√©.", target: "chapitre_4_sanctuaire_approche" }
                ]
            },

            // CHAPITRE IV : Le Sanctuaire du Feu Sacr√© (3 CHOIX)
            "chapitre_4_sanctuaire_approche": {
                title: "La Tentation de l'Ombre",
                text: "Sur le dernier col menant au Sanctuaire, l'√âmissaire de l'Ombre Dormante vous attend. Il vous propose un march√© : lui donner une seule des deux cendres (Sagesse ou Courage) pour qu'il puisse √©quilibrer le mal par la force. Il dit que l'√©quilibre total est trop dangereux. Il vous garantit que le monde sera s√ªr, mais √† moiti√© seulement.",
                choices: [
                    { text: "Refuser le march√© et continuer vers le Sanctuaire.", target: "chapitre_4_climax_total" },
                    { text: "C√©der les Cendres du Courage, par peur de l'√©chec total.", target: "chapitre_4_climax_partiel_courage" },
                    { text: "C√©der les Cendres de la Sagesse, pour garder la force d'agir (le Courage).", target: "chapitre_4_climax_partiel_sagesse" }
                ]
            },
            "chapitre_4_climax_partiel_courage": {
                title: "La Sagesse Seule",
                text: "Vous jetez les Cendres du Courage √† l'√âmissaire. Au Sanctuaire, la Flamme Sacr√©e vacille. L'Ombre est contenue, mais une moiti√© du monde est plong√©e dans la peur et les conflits incessants. Vous avez fait un choix imparfait, mais le monde survit.",
                choices: [
                    { text: "FIN : Succ√®s Partiel. Le Combat Continue.", target: "end_partial_success" }
                ]
            },
            "chapitre_4_climax_partiel_sagesse": {
                title: "Le Courage Seul",
                text: "Vous donnez les Cendres de la Sagesse √† l'√âmissaire. Au Sanctuaire, la Flamme br√ªle avec une fureur brute. L'Ombre est contenue, mais l'humanit√©, bien que courageuse, agit sans r√©fl√©chir, causant des d√©sastres par imprudence. Vous avez fait un choix imparfait, mais le monde survit.",
                choices: [
                    { text: "FIN : Succ√®s Partiel. Le Combat Continue.", target: "end_partial_success" }
                ]
            },
            "chapitre_4_climax_total": {
                title: "Le Triomphe de l'√âquilibre",
                text: "Vous refusez. L'√âmissaire est impuissant face √† la puret√© de votre mission. Vous arrivez au Sanctuaire. Avec les Cendres de la Sagesse et du Courage, vous accomplissez le Rituel de l'√âquilibre. La Flamme Sacr√©e s'√©l√®ve, brillante et constante. L'Ombre Dormante est repouss√©e pour des si√®cles.",
                choices: [
                    { text: "FIN : Victoire Totale. La Paix est R√©tablie.", target: "end_success" }
                ]
            },

            // Fins
            "end_fail": {
                title: "Le R√™ve √âteint",
                text: "Le d√©s√©quilibre s'installe. L'Ombre Dormante √©tend son voile sur le royaume. Vous n'avez pas r√©ussi √† surmonter les √©preuves. Relisez le Compendium des Secrets et tentez de retrouver l'√âquilibre.",
                choices: [
                    { text: "Reprendre l'aventure (D√©but).", target: "start" }
                ]
            },
            "end_partial_success": {
                title: "L'√âquilibre Fragile",
                text: "Le monde est en paix, mais l'Ombre attend son heure. Votre sacrifice a permis de gagner du temps, mais l'harmonie est incompl√®te. C'est le destin de l'√âquilibre, il doit √™tre constamment maintenu.",
                choices: [
                    { text: "Reprendre l'aventure (D√©but).", target: "start" }
                ]
            },
            "end_success": {
                title: "La Lumi√®re √âternelle",
                text: "Votre qu√™te est termin√©e. La Flamme Sacr√©e vous rend √† la vie monastique, mais d√©sormais, vous √™tes un gardien. Les Anciens H√©ros veillent √† travers vous. L'Aetherium est en paix. F√©licitations, Chevalier du Compendium.",
                choices: [
                    { text: "Reprendre l'aventure (D√©but).", target: "start" }
                ]
            }
        };

        // Roman Numeral Converter - Mappage s√ªr pour la conversion
        const romanNumerals = [
            { value: 1000, numeral: 'M' }, { value: 900, numeral: 'CM' }, { value: 500, numeral: 'D' }, 
            { value: 400, numeral: 'CD' }, { value: 100, numeral: 'C' }, { value: 90, numeral: 'XC' }, 
            { value: 50, numeral: 'L' }, { value: 40, numeral: 'XL' }, { value: 10, numeral: 'X' }, 
            { value: 9, numeral: 'IX' }, { value: 5, numeral: 'V' }, { value: 4, numeral: 'IV' }, 
            { value: 1, numeral: 'I' }
        ];

        /**
         * Convertit un nombre arabe en chiffre romain.
         */
        function toRoman(num) {
            if (typeof num !== 'number' || isNaN(num) || num <= 0 || num > 3999) return String(num); 
            let roman = '';
            let currentNum = num;

            for (let i = 0; i < romanNumerals.length; i++) {
                while (currentNum >= romanNumerals[i].value) {
                    roman += romanNumerals[i].numeral;
                    currentNum -= romanNumerals[i].value;
                }
            }
            return roman;
        }

        // --- Configuration et Utilitaire API ---
        const apiKey = ""; // L'API key est fournie par l'environnement Canvas
        
        // URLs des mod√®les
        const API_URL_IMAGE = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
        const API_URL_TEXT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Utility pour la relance avec backoff exponentiel
        async function retryFetch(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}. Body: ${errorBody}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- Fonctions LLM (Gemini API) ---

        /**
         * Affiche l'√©tat de chargement de l'IA.
         */
        function setLoadingState(isLoading, buttonId, message = "Chargement...") {
            const button = document.getElementById(buttonId);
            const resultBox = document.getElementById('ai-result-box');
            const resultText = document.getElementById('ai-result-text');
            const sourcesDiv = document.getElementById('ai-sources');

            if (isLoading) {
                button.disabled = true;
                button.innerHTML = `<svg class="animate-spin h-4 w-4 mr-2 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>${message}`;
                resultBox.classList.add('hidden');
                resultText.textContent = '';
                sourcesDiv.innerHTML = '';
            } else {
                button.disabled = false;
                if (buttonId === 'btn-archiviste') {
                    button.innerHTML = '‚ú® R√©v√©lation de l\'Archiviste';
                } else if (buttonId === 'btn-compendium') {
                    button.innerHTML = 'üìö Consulter le Compendium (Sagesse)';
                }
            }
        }

        /**
         * Affiche le r√©sultat de l'IA et ses sources (s'il y a lieu).
         */
        function displayAIResult(text, sources) {
            const resultBox = document.getElementById('ai-result-box');
            const resultText = document.getElementById('ai-result-text');
            const sourcesDiv = document.getElementById('ai-sources');

            resultText.textContent = text;
            sourcesDiv.innerHTML = ''; 

            if (sources && sources.length > 0) {
                const sourceList = sources.map((s, i) => 
                    `<a href="${s.uri}" target="_blank" class="text-royal-blue hover:underline">${s.title || `Source ${i + 1}`}</a>`
                ).join(', ');
                sourcesDiv.innerHTML = `Sources Compendium: ${sourceList}`;
            }

            resultBox.classList.remove('hidden');
        }

        /**
         * Feature 1: Texte descriptif d√©taill√© (Elaboration)
         */
        async function callGeminiElaboration(sceneTitle, sceneText) {
            setLoadingState(true, 'btn-archiviste', 'Recherche dans les Chroniques...');
            
            const systemPrompt = "Agissez en tant qu'archiviste et scribe v√©n√©rable. √âcrivez un paragraphe concis et profond√©ment immersif (5-7 phrases) qui √©labore sur les d√©tails historiques, spirituels ou sensoriels de la sc√®ne actuelle, offrant √† l'utilisateur une compr√©hension plus riche du monde. R√©pondez uniquement en fran√ßais.";
            const userQuery = `Sc√®ne: "${sceneTitle}". Description: "${sceneText}"`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            try {
                const response = await retryFetch(API_URL_TEXT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Erreur: L'Archiviste est momentan√©ment silencieux.";
                
                displayAIResult(text, []);

            } catch (error) {
                console.error("Erreur Gemini (Archiviste):", error);
                displayAIResult("Le parchemin de l'Archiviste est illisible (Erreur API).", []);
            } finally {
                setLoadingState(false, 'btn-archiviste');
            }
        }

        /**
         * Feature 2: Conseil strat√©gique (Guidance/Grounding)
         */
        async function callGeminiGuidance(sceneText) {
            setLoadingState(true, 'btn-compendium', 'D√©chiffrement du Compendium...');
            
            const systemPrompt = "Agissez en tant que le 'Compendium des Secrets'‚Äîun guide ancien et cryptique. Bas√© sur le dilemme actuel, fournissez un conseil court (3 phrases maximum) qui fait allusion aux vertus de Sagesse, de Courage ou d'√âquilibre. Utilisez un langage m√©taphorique et ancien. R√©pondez uniquement en fran√ßais.";
            const userQuery = `Dilemme actuel: "${sceneText}". Fournissez des conseils.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], // Utilisation du Grounding pour l'information
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await retryFetch(API_URL_TEXT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const candidate = result.candidates?.[0];
                let text = "Les pages du Compendium sont vides (Erreur de d√©cryptage).";
                let sources = [];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    text = candidate.content.parts[0].text;
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title); 
                    }
                }
                
                displayAIResult(text, sources);

            } catch (error) {
                console.error("Erreur Gemini (Compendium):", error);
                displayAIResult("Le Compendium est scell√© par une magie oubli√©e (Erreur API).", []);
            } finally {
                setLoadingState(false, 'btn-compendium');
            }
        }

        // --- Fonctions de Gestion des Illustrations (Dynamique AI avec Fallback SVG) ---

        /**
         * Retourne le contenu SVG contextuel bas√© sur l'ID du Folio (Fallback)
         * [Mise √† jour : Ajout de la classe `gemini-feature-btn` pour le style des boutons IA]
         */
        function getSvgFallback(folioId) {
            let svgPath = "";
            let iconClass = "h-9 w-9 text-royal-blue";
            let fallbackTitle = "Myst√®re";

            switch (folioId) {
                case "start":
                case "chapitre_1_pelerinage":
                    svgPath = '<path d="M12 20h9"/><path d="M16.5 7.5l-9 9c-.63.63-.63 1.65 0 2.28L10 22l4.5-4.5 5.74-5.74a.5.5 0 0 0 .71 0z"/><path d="M12 12l2.5 2.5"/>'; 
                    fallbackTitle = "La R√©v√©lation";
                    break;
                case "chapitre_1_chemins_risques":
                case "chapitre_1_travail_perdu":
                    svgPath = '<path d="M6 19c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM18 21c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/><path d="M17 21h1"/><path d="M12 17V3L7 6l-5 5v12h12v-5z"/><path d="M22 10l-4-4 4-4"/>';
                    iconClass = "h-9 w-9 text-red-600";
                    fallbackTitle = "P√©ril sur la Route";
                    break;
                case "chapitre_1_foret_oubliee":
                case "chapitre_1_meditation":
                case "chapitre_1_vendre_talisman":
                    svgPath = '<path d="M18 10a8 8 0 1 0-8 8"/><path d="M18 10v4h4"/><path d="M3 21l9-18 9 18H3z"/><path d="M10 18h4"/>';
                    fallbackTitle = "Rencontre dans la Brume";
                    break;
                case "chapitre_1_ville_antiquaire":
                case "chapitre_1_eglise":
                case "chapitre_1_bibliotheque":
                case "chapitre_1_observation":
                    svgPath = '<path d="M8 2v10"/><path d="M12 2v10"/><path d="M16 2v10"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M4 8h16"/>';
                    fallbackTitle = "Aethelgard et l'Antiquaire";
                    break;
                case "chapitre_2_enigme_1":
                case "chapitre_2_crypte_prudence":
                case "chapitre_2_ville_service":
                    svgPath = '<path d="M12 16a4 4 0 0 0 4-4c0-4-4-8-4-8s-4 4-4 8a4 4 0 0 0 4 4z"/><path d="M20 8l-2 2-2-2-2 2-2-2-2 2-2-2"/><path d="M4 12h16"/>';
                    fallbackTitle = "L'√ânigme de la Sagesse";
                    break;
                case "chapitre_2_crypte_echec_reponse":
                case "chapitre_2_ville_echec":
                    svgPath = '<path d="M14 10H2"/><path d="M2 6h12"/><path d="M2 14h12"/><path d="M20 18v-4h-2"/><path d="M2 18h12"/>'; 
                    iconClass = "h-9 w-9 text-red-800";
                    fallbackTitle = "Pi√®ge Mortel";
                    break;
                case "chapitre_3_kael_dra_arrivee":
                case "chapitre_3_chercher_aide":
                case "chapitre_3_negociation":
                    svgPath = '<path d="M12 3L2 12h3v8h14v-8h3L12 3z"/><path d="M10 16h4"/>'; 
                    fallbackTitle = "Kael-Dra, le Village Oubli√©";
                    break;
                case "chapitre_3_promesse_action":
                case "chapitre_3_tuer_loup_moral":
                case "chapitre_3_chant_calmant":
                    svgPath = '<path d="M18 9c0-3.5-5-3.5-5-3.5S8 5.5 8 9M2 15h20M12 2l-2 4h4z"/><circle cx="12" cy="15" r="3"/>';
                    fallbackTitle = "L'√âpreuve du Loup";
                    break;
                case "chapitre_3_source_corruption":
                    svgPath = '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M12 11v6"/><path d="M10 15h4"/>'; 
                    iconClass = "h-10 w-10 text-green-700";
                    fallbackTitle = "Source Purifi√©e";
                    break;
                case "chapitre_4_sanctuaire_approche":
                    svgPath = '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M12 11v6"/><path d="M10 15h4"/>';
                    iconClass = "h-10 w-10 text-red-900";
                    fallbackTitle = "La Tentation";
                    break;
                case "chapitre_4_climax_total":
                case "chapitre_4_climax_partiel_courage":
                case "chapitre_4_climax_partiel_sagesse":
                    svgPath = '<path d="M8.5 14.5c.5-1.5 2-2.5 3.5-2.5s3.5 1 4 2.5a3 3 0 0 1-6 0z"/><path d="M12 2a4 4 0 0 0-4 4c0 3 2 5 4 5s4-2 4-5a4 4 0 0 0-4-4z"/>';
                    iconClass = "h-10 w-10 text-ornate-gold";
                    fallbackTitle = "La Flamme Sacr√©e";
                    break;
                case "end_success":
                    svgPath = '<path d="M22 10a10 10 0 1 0-20 0h20z"/><path d="M12 2v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/>';
                    fallbackTitle = "Victoire de l'√âquilibre";
                    break;
                case "end_fail":
                case "end_partial_success":
                    svgPath = '<circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6"/><path d="M9 9l6 6"/>'; 
                    iconClass = "h-9 w-9 text-red-900";
                    fallbackTitle = "L'Ombre S'√©tend";
                    break;
                default:
                    svgPath = '<path d="M12 18v-4"/><path d="M12 22c-3.3 0-6-1.8-6-4s2.7-4 6-4 6 1.8 6 4-2.7 4-6 4z"/><path d="M17 14c0-3.3-2.7-6-6-6s-6 2.7-6 6"/><path d="M12 2l-4 4 4 4 4-4z"/>';
                    fallbackTitle = "Relique des Anciens";
            }

            // SVG structure 
            const svgContent = `
                <svg class="${iconClass} mb-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    ${svgPath}
                </svg>
            `;

            return { svgContent, fallbackTitle };
        }

        // Fonction pour g√©n√©rer le prompt stylis√© pour l'IA (Image)
        function getFolioPrompt(folioId) {
            const defaultStyle = "enluminure d√©taill√©e, style dessin √† l'encre m√©di√©val, couleurs vives sur parchemin, ornementation florale et dor√©e, haute fantaisie, vue rapproch√©e de l'illustration.";
            
            let specificScene;
            switch (folioId) {
                case "start":
                    specificScene = "Un jeune moine chevalier sans armure sort d'un monast√®re aust√®re au lever du soleil, tenant un grand livre ancien sous le bras.";
                    break;
                case "chapitre_1_chemins_risques":
                case "chapitre_1_travail_perdu":
                    specificScene = "Des brigands ricanant sur une route poussi√©reuse laissant un moine s'en aller, le tout sous un soleil de plomb. Ambiance de la Renaissance sombre.";
                    break;
                case "chapitre_1_foret_oubliee":
                case "chapitre_1_meditation":
                case "chapitre_1_vendre_talisman":
                    specificScene = "Un moine √©coutant une vieille femme myst√©rieuse (une ermite) assise pr√®s d'un feu de camp dans une for√™t brumeuse et sombre.";
                    break;
                case "chapitre_1_ville_antiquaire":
                case "chapitre_2_ville_service":
                    specificScene = "Un moine pauvre parlant √† un vieil antiquaire corpulent, entour√© de parchemins et de tr√©sors dans une boutique anim√©e et sombre de la ville d'Aethelgard.";
                    break;
                case "chapitre_2_enigme_1":
                case "chapitre_2_crypte_prudence":
                    specificScene = "Une petite urne ancienne et poussi√©reuse dans une crypte silencieuse, illumin√©e par un rayon de soleil, repr√©sentant les Cendres de la Sagesse.";
                    break;
                case "chapitre_3_kael_dra_arrivee":
                case "chapitre_3_chercher_aide":
                case "chapitre_3_negociation":
                    specificScene = "Un village de montagne abandonn√© et silencieux, vu √† travers une brume √©paisse, avec une seule vieille femme regardant le moine.";
                    break;
                case "chapitre_3_promesse_action":
                case "chapitre_3_tuer_loup_moral":
                case "chapitre_3_chant_calmant":
                    specificScene = "Un moine chevalier observant un loup massif et souffrant dans la brume, son talisman brillant faiblement en tant qu'indice. Sc√®ne de nuit.";
                    break;
                case "chapitre_3_source_corruption":
                    specificScene = "Une petite fissure dans le lit d'une rivi√®re de montagne, suintant une encre noire et mal√©fique, le moine utilisant son √©nergie pour la sceller.";
                    break;
                case "chapitre_4_sanctuaire_approche":
                    specificScene = "Un homme v√™tu d'une robe d'or et portant un air de fausse bont√© attendant le moine sur un col de montagne, le Sanctuaire du Feu Sacr√© visible au loin.";
                    break;
                case "chapitre_4_climax_total":
                    specificScene = "Une grande flamme bleue et or au centre d'un autel de pierre, le moine y d√©posant deux urnes de cendres, la sc√®ne rayonnant de lumi√®re et de paix.";
                    break;
                case "end_success":
                    specificScene = "Le moine chevalier, serein, devant un symbole de paix et d'√©quilibre cosmique rayonnant. Style vitrail m√©di√©val.";
                    break;
                default:
                    specificScene = "Le Compendium des Secrets Herm√©tiques (un grimoire) reposant ouvert sous la lumi√®re des √©toiles.";
            }

            return `${specificScene}. ${defaultStyle}`; 
        }
        
        /**
         * G√©n√®re une image dynamique via l'API Google et l'affiche, ou un placeholder SVG en cas d'√©chec.
         */
        async function generateIllustration(folioId, targetElementId) {
            const prompt = getFolioPrompt(folioId);
            const folioTextContent = document.getElementById(targetElementId);
            
            // R√©cup√©rer le texte actuel pour le r√©ins√©rer apr√®s le chargement/l'image
            const currentText = gameData[folioId].text; 
            
            // 1. Cr√©er et ins√©rer l'indicateur de chargement (Spinner)
            const loadingHtml = `
                <div id="image-loading-container" class="enluminure-frame float-left mr-4 mb-2 w-32 h-32 flex flex-col items-center justify-center text-center bg-parchment-shadow/70 text-ink-dark/70 transform rotate-[-0.5deg]">
                    <svg class="animate-spin h-6 w-6 text-royal-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="mt-2 text-xs font-body">Cr√©ation de l'Enluminure...</span>
                </div>
            `;
            folioTextContent.innerHTML = loadingHtml + `<p class="story-paragraph">${currentText.replace(/\n/g, '<br>')}</p>`;
            
            const loadingContainer = document.getElementById('image-loading-container');

            // 2. Pr√©parer la requ√™te API
            const payload = {
                instances: [{ prompt: prompt }],
                parameters: { "sampleCount": 1 }
            };

            try {
                const response = await retryFetch(API_URL_IMAGE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;
                
                if (base64Data) {
                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    
                    // Cr√©er l'√©l√©ment Image
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = `Enluminure de la sc√®ne: ${prompt}`;
                    // Utiliser la m√™me classe de cadre que le loading container
                    img.className = "enluminure-frame float-left mr-4 mb-2 w-32 h-32 object-cover bg-parchment-base";

                    // Remplacer le conteneur de chargement par l'image
                    if (loadingContainer) {
                        loadingContainer.parentNode.insertBefore(img, loadingContainer);
                        loadingContainer.remove();
                    }
                } else {
                    // Si l'API ne retourne pas de donn√©es, utiliser le fallback SVG
                    throw new Error("API did not return image data.");
                }

            } catch (error) {
                console.error("Erreur lors de la g√©n√©ration de l'image (l'IA est peut-√™tre temporairement indisponible) :", error);
                
                // --- LOGIC POUR LE FALLBACK SVG CONTEXTUEL ---
                const { svgContent, fallbackTitle } = getSvgFallback(folioId);
                
                if (loadingContainer) {
                    // Mettre √† jour le style pour l'ic√¥ne SVG
                    loadingContainer.className = "enluminure-frame float-left mr-4 mb-2 w-32 h-32 flex flex-col items-center justify-center text-center bg-parchment-shadow/70 text-ink-dark/70 transform rotate-[-0.5deg]";
                    loadingContainer.innerHTML = `
                        ${svgContent}
                        <span class="mt-1 text-xs font-semibold font-body">${fallbackTitle}</span>
                    `; 
                }
                // --- FIN LOGIC ---
            }
        }

        // Fonction pour charger un folio sp√©cifique
        function loadFolio(folioId) {
            const folio = gameData[folioId];
            if (!folio) {
                console.error("Folio ID inconnu:", folioId);
                return;
            }

            document.getElementById('folio-title').textContent = folio.title;
            
            const folioTextContent = document.getElementById('folio-text-content');
            
            // 1. Cacher les r√©sultats IA pr√©c√©dents
            document.getElementById('ai-result-box').classList.add('hidden');

            // 2. Vider l'ancien contenu
            folioTextContent.innerHTML = '';
            
            // 3. Ins√©rer le texte et l'illustration
            // La fonction generateIllustration g√®re la structure <p class="story-paragraph"> et l'insertion du spinner/image
            generateIllustration(folioId, 'folio-text-content'); 
            
            // 4. Mettre √† jour les boutons d'aide IA
            const btnArchiviste = document.getElementById('btn-archiviste');
            const btnCompendium = document.getElementById('btn-compendium');
            
            // Les fins ne n√©cessitent pas de conseils ou d'explications suppl√©mentaires.
            const isEnd = folioId.startsWith('end_');
            const featureContainer = document.getElementById('ai-features');
            
            if (isEnd) {
                featureContainer.classList.add('hidden');
            } else {
                featureContainer.classList.remove('hidden');
                // Mise √† jour des onClick avec les donn√©es de la sc√®ne actuelle
                btnArchiviste.onclick = () => callGeminiElaboration(folio.title, folio.text);
                btnCompendium.onclick = () => callGeminiGuidance(folio.text);
                setLoadingState(false, 'btn-archiviste');
                setLoadingState(false, 'btn-compendium');
            }


            const choicesContainer = document.getElementById('folio-choices');
            choicesContainer.innerHTML = ''; // Nettoyer les anciens choix
            
            // --- Logique pour afficher le num√©ro de Folio en chiffres romains (d√©coratif) ---
            const allKeys = Object.keys(gameData);
            const index = allKeys.indexOf(folioId);
            const folioLabel = index !== -1 ? toRoman(index + 1) : folioId.toUpperCase();
            
            document.getElementById('folio-number').textContent = 'Page de Manuscrit ' + folioLabel;
            // --- Fin de la Logique de chiffres romains ---

            // G√©n√©rer les nouveaux choix
            folio.choices.forEach((choice, index) => {
                const button = document.createElement('button');
                // Styles de bouton adapt√©s au th√®me Royal
                const choiceNumberRoman = toRoman(index + 1);
                button.className = 'manuscript w-full text-left p-3 my-2 border border-royal-blue/50 rounded-lg bg-parchment-shadow hover:bg-parchment-base transition duration-150 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-royal-blue/70';
                
                button.textContent = `${choiceNumberRoman}. ${choice.text}`;
                
                button.onclick = () => loadFolio(choice.target);
                choicesContainer.appendChild(button);
            });
        }
        
        // D√©marrer le jeu au chargement de la page
        window.onload = () => loadFolio("start");
    </script>
    <style>
        /* Importation des polices : Uncial Antiqua (Titres) et IM Fell English (Corps) */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=IM+Fell+English:ital@0;1&family=Uncial+Antiqua&display=swap');
        
        /* Styles pour l'immersion Grimoire Royal High Fantasy */
        body {
            font-family: 'IM Fell English', serif; 
            /* Fond High Fantasy : Bleu Saphir */
            background-color: #3e5c76; 
            color: #301f14; 
            min-height: 100vh;
            display: flex;
            flex-direction: column; 
            justify-content: flex-start;
            align-items: center;
            padding: 10px 0; /* Padding r√©duit sur mobile */
            /* Ajout d'une texture pour l'ambiance royale/historique */
            background-image: linear-gradient(rgba(255,255,255,0.08) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 15px 15px;
        }
        @media (min-width: 640px) {
            body {
                padding: 20px 0; /* Plus de padding sur desktop */
            }
        }

        .audio-controls {
            max-width: 800px;
            width: 95%;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fcf4d4; 
            border: 2px solid #3e5c76; 
            border-radius: 8px;
            text-align: center;
        }
        
        .container {
            max-width: 800px;
            width: 95%;
            /* Fond Parchemin plus clair et jaune (authentique) */
            background-color: #fcf4d4;
            /* Bordure Noble : Bleu Saphir */
            border: 8px solid #3e5c76; 
            box-shadow: 10px 10px 30px rgba(0, 0, 0, 0.4);
            /* Petit effet de page courb√©e */
            transform: rotateZ(0.2deg); 
            line-height: 1.7; 
            letter-spacing: 0.05em; 
            padding: 1rem; /* Base padding r√©duit pour mobile */
            display: flex; 
            flex-direction: column;
            min-height: 700px;
        }
        @media (min-width: 640px) {
            .container {
                padding: 1.5rem 2rem; /* Plus de padding sur desktop */
            }
        }
        
        /* Style du texte manuscrit (adapt√© aux nouvelles couleurs) */
        .manuscript {
            color: #301f14; 
            line-height: 1.7;
            font-size: 1.1rem;
        }
        
        /* Titre orn√© (adapt√© aux nouvelles polices et couleurs) */
        .ornate-title {
            color: #cdac60; 
            text-shadow: 1px 1px 2px #3e5c76; 
            font-family: 'Uncial Antiqua', 'serif'; 
            letter-spacing: 2px;
            border-bottom: 3px solid #cdac60;
            display: inline-block;
            padding-bottom: 8px;
            margin-bottom: 1.5rem;
            font-weight: 700;
        }

        /* Nouveau style pour le cadre d'enluminure (appliqu√© au chargement et √† l'image) */
        .enluminure-frame {
            border: 2px solid #cdac60; /* Ornementation dor√©e */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 0.5rem; /* Coins l√©g√®rement arrondis */
            padding: 4px;
            transition: all 0.3s;
        }
        
        /* Styles sp√©cifiques au jeu pour le premier mot en capitale (Lettrine) */
        /* Cible le premier paragraphe du contenu textuel, juste apr√®s l'image flottante */
        #folio-text-content .story-paragraph::first-letter {
            font-size: 3.5rem;
            line-height: 1;
            float: left;
            margin-right: 0.1em;
            color: #cdac60; 
            font-family: 'Uncial Antiqua', 'serif';
        }

        /* Style sp√©cifique pour les boutons de fonctionnalit√©s Gemini */
        .gemini-feature-btn {
            @apply inline-flex items-center text-sm font-semibold text-royal-blue border border-royal-blue/50 rounded-lg bg-parchment-shadow hover:bg-parchment-base transition duration-150 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-ornate-gold px-3 py-2;
            font-family: 'IM Fell English', serif;
        }
    </style>
</head>
<body>

    <!-- Contr√¥les audio -->
    <div class="audio-controls">
        <p class="manuscript text-base italic">
            Ambiance sonore : <span class="font-title">Musique de Qu√™te (Simul√©e)</span>
        </p>
        <audio controls loop class="mt-2 w-full max-w-sm mx-auto">
            <source src="placeholder.mp3" type="audio/mpeg">
            Votre navigateur ne supporte pas l'√©l√©ment audio.
        </audio>
    </div>

    <!-- Conteneur principal -->
    <div class="container">

        <!-- Partie Contenu du Folio -->
        <div class="flex-grow">
            <!-- Titre du Folio -->
            <h2 id="folio-title" class="text-3xl text-center ornate-title mx-auto">Chargement...</h2>
            
            <!-- Conteneur du Texte de l'histoire et de l'Illustration -->
            <div id="folio-text-content" class="manuscript mb-6 text-xl">
                <!-- L'image IA, le spinner ou le SVG de fallback sera ins√©r√© ici par JS -->
            </div>

            <!-- NOUVELLE SECTION : Fonctionnalit√©s LLM (Gemini) -->
            <div id="ai-features" class="my-4 border-t pt-4 border-royal-blue/30 space-y-3">
                <div class="flex flex-wrap gap-2">
                    <button id="btn-archiviste" class="gemini-feature-btn">
                        ‚ú® R√©v√©lation de l'Archiviste
                    </button>
                    <button id="btn-compendium" class="gemini-feature-btn">
                        üìö Consulter le Compendium (Sagesse)
                    </button>
                </div>
                
                <!-- Bo√Æte de R√©sultat de l'IA -->
                <div id="ai-result-box" class="mt-4 p-4 border-2 border-ornate-gold rounded-lg bg-parchment-shadow/70 shadow-inner hidden">
                    <p class="font-title text-ink-dark/90 mb-1">D√©p√™che de l'Au-Del√† :</p>
                    <p id="ai-result-text" class="text-base italic manuscript"></p>
                    <div id="ai-sources" class="mt-3 text-xs text-ink-dark/60 border-t border-ink-dark/10 pt-1"></div>
                </div>
            </div>
            <!-- FIN NOUVELLE SECTION -->

            <!-- Conteneur des Choix -->
            <div id="folio-choices" class="mt-8 space-y-3">
                <!-- Les boutons de choix seront ins√©r√©s ici par JavaScript -->
            </div>
        </div>
        
        <!-- Num√©ro du Folio en bas de page -->
        <div class="mt-auto text-right text-sm italic text-ink-dark/70 pt-4 border-t border-royal-blue/30">
            <span id="folio-number"></span>
        </div>
    </div>

</body>
</html>
